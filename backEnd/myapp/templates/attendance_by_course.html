{% extends 'base.html' %}

{% block content %}
{% csrf_token %}
<h1>Presentes en la {{course.name}}</h1>

{%if matriculation %}
<table>
  <thead>
    <tr>
      <th>DNI</th>
      <th>Nombre del estudiante</th>
    </tr>
  </thead>
  <tbody>
    {%for student_info in matriculation%}
      <tr>
        <th>{{student_info.student_id.id}}</th>
        <th>{{student_info.student_id.surname}}, {{student_info.student_id.name}}</th>
        <th><button class="mark-attendance" id="{{student_info.student_id.id}}">Marcar asistencia</button></th>
      </tr>
    {%endfor%}
  </tbody>
</table>
<script>
  // Seleccionamos todos los botones que permiten marcar la asistencia
const buttons = document.querySelectorAll('.mark-attendance');

// Agregamos un event listener a cada botón
for (let i = 0; i < buttons.length; i++) {
buttons[i].addEventListener('click', function(e) {

  // Definimos los datos necesarios para marcar la asistencia
  // Obtenemos el ID del estudiante al presionar el botón
  const studentId = e.target.id
  // imprimir el ID del estudiante para pruebas
  console.log(studentId);
  const url = window.location.href;
  // dividir la URL en partes utilizando el carácter "/"
  const parts = url.split('/');
  // tomar la última parte que representa el ID del estudiante
  const courseId = parts[parts.length - 2];
  console.log(courseId);
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // Creamos una petición HTTP POST
  const request = new XMLHttpRequest();
  request.open('POST', '/mark_attendance');
  request.setRequestHeader('X-CSRFToken', csrftoken);
  request.setRequestHeader('Accept', 'application/json');

  // Creamos un objeto FormData con los datos de la asistencia
  const formData = new FormData();
  formData.append('course_id', courseId);
  formData.append('student_id', studentId);
  // por alguna razon que todavia no entiendo: la fecha se agrega automaticamente con la fecha de la computadora
  // en el archivo models hay un parametro que podria indicar esto pero al sacarlo y realizar la migracion, no cambia ese funcionamiento 
  formData.append('present', 'True');

  // Enviamos la petición con los datos de la asistencia
  request.send(formData);
  });
}
</script>
{%endif%}

{% if attendances and matriculation %}
<table>
  <thead>
    <tr>
      <th>Nombre del estudiante</th>
      <th>Fecha</th>
      <th>¿Asistió?</th>
    </tr>
  </thead>
  <tbody>
    {% for attendance in attendances %}
      {% for matriculation_item in matriculation %}
        {% if attendance.student == matriculation_item.student_id %}
          <tr>
            <td>{{ attendance.student.name }} {{ attendance.student.id }}</td>
            <td>{{ attendance.date }}</td>
            <td>
              {% if attendance.present == 1 %}
                Presente
              {% else %}
                Ausente
              {% endif %}
            </td>
          </tr>
        {% endif %}
      {% endfor %}
    {% endfor %}
  </tbody>
</table>
{% else %}
  <p>No hay presentes registrados para esta materia.</p>
{% endif %}
{% endblock %}
